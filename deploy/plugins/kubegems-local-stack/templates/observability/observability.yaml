{{- if .Values.observability.enabled }}
{{- if not .Values.observability.jaeger.externalElasticsearch -}}
---
# https://github.com/elastic/helm-charts
apiVersion: plugins.kubegems.io/v1beta1
kind: Plugin
metadata:
  name: elasticsearch
  namespace: {{ .Release.Namespace }}
spec:
  enabled: true
  kind: helm
  installNamespace: {{.Values.observability.namespace }}
  repo: https://helm.elastic.co
  version: 7.17.1
  values:
    replicas: 1
    minimumMasterNodes: 1
    # image: "docker.elastic.co/elasticsearch/elasticsearch"
    {{ include "common.images.repository" ( dict "key" "image" "registry" "docker.elastic.co" "repository" "elasticsearch/elasticsearch" "context" .) }}
{{- end }}
---
# https://github.com/jaegertracing/helm-charts
apiVersion: plugins.kubegems.io/v1beta1
kind: Plugin
metadata:
  name: jaeger-operator
  namespace: {{ .Release.Namespace }}
spec:
  enabled: true
  kind: helm
  installNamespace: {{.Values.observability.namespace }}
  repo: https://jaegertracing.github.io/helm-charts
  version: {{ .Values.observability.chartVersion }}
  values:
    image:
      # repository: docker.io/jaegertracing/jaeger-operator
      {{ include "common.images.repository" ( dict "registry" "docker.io" "repository" "jaegertracing/jaeger-operator" "context" .) }}
      tag: {{ .Values.observability.jaeger.version }}
    rbac:
      clusterRole: true
    jaeger:
      create: true
      spec: 
        strategy: production
        ingress:
          enabled: false
        collector:
          options:
            collector.zipkin.host-port: "9411"
        storage:
          type: elasticsearch
          options:
            es:
              {{- if .Values.observability.jaeger.externalElasticsearch }}
              server-urls: {{ .Values.observability.jaeger.externalElasticsearch.address }}
              {{- else }}
              server-urls: http://elasticsearch-master.observability:9200
              {{- end }}
---
kind: Service
apiVersion: v1
metadata:
  name: jaeger-query  # jaeger-operator's svc name is jaeger-operator-jaeger-query,create a new service for jaeger-query
  namespace: {{.Values.observability.namespace }}
spec:
  selector:
    app: jaeger
    app.kubernetes.io/component: query
  ports:
    - name: http-query
      port: 16686
      targetPort: 16686
    - name: grpc-query
      port: 16685
      targetPort: 16685
{{- end -}}
